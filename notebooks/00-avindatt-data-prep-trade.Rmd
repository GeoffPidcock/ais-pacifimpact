---
title: "Data Prep - Pacific Islands Trade"
author: "Avin Datt - PacifImpact"
date: "03 September 2020"
output: 
  github_document
---

# Scope  

Ingest IMTS Data into PostgreSQL database. 

# Reference

IMTS data is available in .xlsx format. It can be downloaded from [SPC Statistics for Development Division](https://sdd.spc.int/contact-us#disclaimer)

# Load Libraries 

```{r}
# Load openxlsx library 
if (!require(openxlsx)) {
  install.packages("openxlsx")
  library(openxlsx)
}

# Load purrr library
if (!require(purrr)) {
  install.packages("purrr")
  library(purrr)
}

# Load data.table library
if (!require(data.table)) {
  install.packages("data.table")
  library(data.table)
}

# Load DBI library
if (!require(DBI)) {
  install.packages("DBI")
  library(DBI)
}

# Load DBI library
if (!require(RPostgres)) {
  install.packages("RPostgres")
  library(RPostgres)
}

```

# Read Fiji Data 

Read in Balance of Trade - All Items for Fiji.

```{r}
# Read in Fiji File 
fj.imts.bot <- read.xlsx(xlsxFile = 'C:/Users/Avin/Documents/Data/Hackathon/AIS/ais-pacifimpact/data/external/Fiji_IMTS_Tables_2020.xlsx',
                         sheet = 1, 
                         startRow = 28,
                         skipEmptyCols = TRUE,
                         detectDates = TRUE,
                         rows = c(28:111),
                         cols = c(1:7))


```

Add and fix missing variable names. 

```{r}
# fj.imts.bot to data.table 
fj.imts.bot <- data.table(fj.imts.bot)


# Fix Monthly label to Year
setnames(fj.imts.bot, 
         "Monthly",
         "year")


# X2 should be Month 
setnames(fj.imts.bot, 
         "X2",
         "month")


# Exports FOB Domestic 
setnames(fj.imts.bot, 
         "X3",
         "exports-fob-domestic")


# Exports FOB Re-Export 
setnames(fj.imts.bot, 
         "X4",
         "exports-fob-reexport")


# Exports FOB Total 
setnames(fj.imts.bot, 
         "X5",
         "exports-fob-total")


# Imports CIF
setnames(fj.imts.bot, 
         "X6",
         "imports-cif")



# Trade Balance
setnames(fj.imts.bot, 
         "X7",
         "trade-balance")


```

Update Year values.

```{r}
# Update by using row number references
# 2014
fj.imts.bot[1:12, 
            year := 2014]


# 2015
fj.imts.bot[13:24, 
            year := 2015]


# 2016
fj.imts.bot[25:36, 
            year := 2016]


# 2017
fj.imts.bot[37:48, 
            year := 2017]


# 2018
fj.imts.bot[49:60, 
            year := 2018]


# 2019
fj.imts.bot[61:72, 
            year := 2019]


# 2020
fj.imts.bot[73:77, 
            year := 2020]


```

Melt the table to adhere to the key-value pair schema design. 

```{r}
# Melt the data to adhere to the schema design
fj.imts.bot <- melt.data.table(fj.imts.bot,
                               id = c("year",
                                      "month"), measure = c("exports-fob-domestic",
                                                            "exports-fob-reexport", 
                                                            "exports-fob-total",
                                                            "imports-cif",
                                                            "trade-balance"))
```

Create Date from year and month. 

```{r}
# Concatenate
fj.imts.bot[, 
            date := paste0(gsub(" ", "", year, fixed = TRUE),
                           "-",
                           gsub(" ", "",month, fixed = TRUE),
                           "-",
                           "01")]


# Format Date
fj.imts.bot[, 
            date := as.Date(date, format = "%Y-%B-%d")]


# Remove year and month fields 
fj.imts.bot[, 
            year := NULL][, 
                          month := NULL]
```

Rename "variable" to "name". 

```{r}
# Rename variable to name 
setnames(fj.imts.bot, 
         "variable",
         "name")

```

Add metric key, frequency, country, category, source and property informations. 

```{r}
# Metric 
fj.imts.bot[, 
            `:=` (frequency = "monthly", 
                  country = "fj", 
                  category = "trade", 
                  source = "imts", 
                  properties = "{'currency' = 'fjd'}",
                  metric_key = paste0("fj","-",name,"-",date))]

```

Reorder data. 

```{r}
# Change order of columns to align with schema
fj.imts.bot <- fj.imts.bot[,
                           .(metric_key,
                             frequency, 
                             country,
                             category, 
                             source,
                             name,
                             date, 
                             value,
                             properties)]
```

# Read Cook Islands Data 

Read in Balance of Trade - All Items for Cook Islands.

```{r}
# Read in Fiji File 
ck.imts.bot <- read.xlsx(xlsxFile = 'C:/Users/Avin/Documents/Data/Hackathon/AIS/ais-pacifimpact/data/external/Cook_IMTS_Tables_2020.xlsx',
                         sheet = 1, 
                         startRow = 15,
                         skipEmptyCols = TRUE,
                         detectDates = TRUE,
                         rows = c(15:58),
                         cols = c(1:7))


# Remove rows with no month value 

```

Add and fix missing variable names. 

```{r}
# ck.imts.bot to data.table 
ck.imts.bot <- data.table(ck.imts.bot)


# Fix Monthly label to Year
setnames(ck.imts.bot, 
         "Monthly",
         "year")


# X2 should be Month 
setnames(ck.imts.bot, 
         "X2",
         "month")


# Exports FOB Domestic 
setnames(ck.imts.bot, 
         "X3",
         "exports-fob-domestic")


# Exports FOB Re-Export 
setnames(ck.imts.bot, 
         "X4",
         "exports-fob-reexport")


# Exports FOB Total 
setnames(ck.imts.bot, 
         "X5",
         "exports-fob-total")


# Imports CIF
setnames(ck.imts.bot, 
         "X6",
         "imports-cif")



# Trade Balance
setnames(ck.imts.bot, 
         "X7",
         "trade-balance")


```

Remove rogue empty row. 

```{r}
ck.imts.bot <- ck.imts.bot[!is.na(month)]
```


Update Year values.

```{r}
# Update by using row number references
# 2017
ck.imts.bot[1:12, 
            year := 2017]


# 2015
ck.imts.bot[13:24, 
            year := 2018]


# 2016
ck.imts.bot[25:36, 
            year := 2019]


# 2017
ck.imts.bot[37:40, 
            year := 2020]


```

Melt the table to adhere to the key-value pair schema design. 

```{r}
# Melt the data to adhere to the schema design
ck.imts.bot <- melt.data.table(ck.imts.bot,
                               id = c("year",
                                      "month"), measure = c("exports-fob-domestic",
                                                            "exports-fob-reexport", 
                                                            "exports-fob-total",
                                                            "imports-cif",
                                                            "trade-balance"))
```

Create Date from year and month. 

```{r}
# Concatenate
ck.imts.bot[, 
            date := paste0(gsub(" ", "", year, fixed = TRUE),
                           "-",
                           gsub(" ", "",month, fixed = TRUE),
                           "-",
                           "01")]


# Format Date
ck.imts.bot[, 
            date := as.Date(date, format = "%Y-%B-%d")]


# Remove year and month fields 
ck.imts.bot[, 
            year := NULL][, 
                          month := NULL]
```

Rename "variable" to "name". 

```{r}
# Rename variable to name 
setnames(ck.imts.bot, 
         "variable",
         "name")

```

Add metric key, frequency, country, category, source and property informations. 

```{r}
# Metric 
ck.imts.bot[, 
            `:=` (frequency = "monthly", 
                  country = "ck", 
                  category = "trade", 
                  source = "imts", 
                  properties = "{'currency' = 'nzd'}",
                  metric_key = paste0("ck","-",name,"-",date))]

```

Reorder data. 

```{r}
# Change order of columns to align with schema
ck.imts.bot <- ck.imts.bot[,
                           .(metric_key,
                             frequency, 
                             country,
                             category, 
                             source,
                             name,
                             date, 
                             value,
                             properties)]
```


# Read Solomon Islands Data 

Read in Balance of Trade - All Items for Cook Islands.

```{r}
# Read in Fiji File 
sl.imts.bot <- read.xlsx(xlsxFile = 'C:/Users/Avin/Documents/Data/Hackathon/AIS/ais-pacifimpact/data/external/Solomon_Islands_IMTS_Tables_2020.xlsx',
                         sheet = 1, 
                         startRow = 25,
                         skipEmptyCols = TRUE,
                         detectDates = TRUE,
                         rows = c(25:41),
                         cols = c(1:7))


# Remove rows with no month value 

```

Add and fix missing variable names. 

```{r}
# sl.imts.bot to data.table 
sl.imts.bot <- data.table(sl.imts.bot)


# Fix Monthly label to Year
setnames(sl.imts.bot, 
         "Monthly",
         "year")


# X2 should be Month 
setnames(sl.imts.bot, 
         "X2",
         "month")


# Exports FOB Domestic 
setnames(sl.imts.bot, 
         "X3",
         "exports-fob-domestic")


# Exports FOB Re-Export 
setnames(sl.imts.bot, 
         "X4",
         "exports-fob-reexport")


# Exports FOB Total 
setnames(sl.imts.bot, 
         "X5",
         "exports-fob-total")


# Imports CIF
setnames(sl.imts.bot, 
         "X6",
         "imports-cif")



# Trade Balance
setnames(sl.imts.bot, 
         "X7",
         "trade-balance")


```

Update Year values.

```{r}
# Update by using row number references
# 2018
sl.imts.bot[1:12, 
            year := 2018]


# 2019
sl.imts.bot[13:15, 
            year := 2019]


```

Melt the table to adhere to the key-value pair schema design. 

```{r}
# Melt the data to adhere to the schema design
sl.imts.bot <- melt.data.table(sl.imts.bot,
                               id = c("year",
                                      "month"), measure = c("exports-fob-domestic",
                                                            "exports-fob-reexport", 
                                                            "exports-fob-total",
                                                            "imports-cif",
                                                            "trade-balance"))
```

Create Date from year and month. 

```{r}
# Concatenate
sl.imts.bot[, 
            date := paste0(gsub(" ", "", year, fixed = TRUE),
                           "-",
                           gsub(" ", "",month, fixed = TRUE),
                           "-",
                           "01")]


# Format Date
sl.imts.bot[, 
            date := as.Date(date, format = "%Y-%B-%d")]


# Remove year and month fields 
sl.imts.bot[, 
            year := NULL][, 
                          month := NULL]
```

Rename "variable" to "name". 

```{r}
# Rename variable to name 
setnames(sl.imts.bot, 
         "variable",
         "name")

```

Add metric key, frequency, country, category, source and property informations. 

```{r}
# Metric 
sl.imts.bot[, 
            `:=` (frequency = "monthly", 
                  country = "sl", 
                  category = "trade", 
                  source = "imts", 
                  properties = "{'currency' = 'sbd'}",
                  metric_key = paste0("sl","-",name,"-",date))]

```

Reorder data. 

```{r}
# Change order of columns to align with schema
sl.imts.bot <- sl.imts.bot[,
                           .(metric_key,
                             frequency, 
                             country,
                             category, 
                             source,
                             name,
                             date, 
                             value,
                             properties)]
```


# Append to PostgresSQL Database 

Connect to the hosted PostgreSQL database. 

Table used is country_metrics. 

## Fiji IMTS Balance of Trade Upload

Prior to upload, the country_metrics table had 429 existing records. 

After the upload, the same table has 814 records. 

The difference equates to the 385 row count of the Fiji IMTS dataset. This means data was successfully uploaded. 

```{r}
# Connect to a specific postgres database i.e. Heroku
db.con <- dbConnect(RPostgres::Postgres(),
                    dbname = 'aishackathon', 
                    host = 'ais-hack.cirquhp75zcc.us-east-2.rds.amazonaws.com', 
                    port = 5432, 
                    user = rstudioapi::askForPassword("Database user"),
                    password = rstudioapi::askForPassword("Database password"))

# See what tables are available 
dbListTables(db.con)


# Count rows before upload
rc1 <- RPostgres::dbSendQuery(db.con, "SELECT count(*) as count FROM country_metrics")


count_recs1 <- dbFetch(rc1)
#429


# # Append fj.imts.bot to country_metrics
# RPostgres::dbWriteTable(db.con,
#                         "country_metrics", 
#                         fj.imts.bot,
#                         append = TRUE,
#                         row.names = FALSE)


# Count rows after upload
rs2 <- RPostgres::dbSendQuery(db.con, "SELECT count(*) as count FROM country_metrics")


count_recs2 <- dbFetch(rs2)
#814


dbDisconnect(db.con)
```

## Solomon Islands IMTS Balance of Trade Upload

Prior to upload, the country_metrics table had 814 existing records. 

After the upload, the same table has 889 records. 

The difference equates to the 75 row count of the Solomon Islands IMTS dataset. This means data was successfully uploaded. 

```{r}
# Connect to a specific postgres database i.e. Heroku
db.con <- dbConnect(RPostgres::Postgres(),
                    dbname = 'aishackathon', 
                    host = 'ais-hack.cirquhp75zcc.us-east-2.rds.amazonaws.com', 
                    port = 5432, 
                    user = rstudioapi::askForPassword("Database user"),
                    password = rstudioapi::askForPassword("Database password"))

# See what tables are available 
dbListTables(db.con)


# Count rows before upload
rc3 <- RPostgres::dbSendQuery(db.con, "SELECT count(*) as count FROM country_metrics")


count_recs3 <- dbFetch(rc3)
#814


# # Append sl.imts.bot to country_metrics
# RPostgres::dbWriteTable(db.con,
#                         "country_metrics",
#                         sl.imts.bot,
#                         append = TRUE,
#                         row.names = FALSE)


# Count rows after upload
rs4 <- RPostgres::dbSendQuery(db.con, "SELECT count(*) as count FROM country_metrics")


count_recs4 <- dbFetch(rs4)
#889

dbDisconnect(db.con)
```

## Cook Islands IMTS Balance of Trade Upload

Prior to upload, the country_metrics table had 889 existing records. 

After the upload, the same table has 1089 records. 

The difference equates to the 200 row count of the Cook Islands IMTS dataset. This means data was successfully uploaded. 

```{r}
# Connect to a specific postgres database i.e. Heroku
db.con <- dbConnect(RPostgres::Postgres(),
                    dbname = 'aishackathon', 
                    host = 'ais-hack.cirquhp75zcc.us-east-2.rds.amazonaws.com', 
                    port = 5432, 
                    user = rstudioapi::askForPassword("Database user"),
                    password = rstudioapi::askForPassword("Database password"))

# See what tables are available 
dbListTables(db.con)


# Count rows before upload
rc5 <- RPostgres::dbSendQuery(db.con, "SELECT count(*) as count FROM country_metrics")


count_recs5 <- dbFetch(rc5)
#889


# # Append ck.imts.bot to country_metrics
# RPostgres::dbWriteTable(db.con,
#                         "country_metrics",
#                         ck.imts.bot,
#                         append = TRUE,
#                         row.names = FALSE)


# Count rows after upload
rs6 <- RPostgres::dbSendQuery(db.con, "SELECT count(*) as count FROM country_metrics")


count_recs6 <- dbFetch(rs6)
#1089

dbDisconnect(db.con)
```


# country_metrics

```{r}
# Connect to a specific postgres database i.e. Heroku
db.con <- dbConnect(RPostgres::Postgres(),
                    dbname = 'aishackathon', 
                    host = 'ais-hack.cirquhp75zcc.us-east-2.rds.amazonaws.com', 
                    port = 5432, 
                    user = rstudioapi::askForPassword("Database user"),
                    password = rstudioapi::askForPassword("Database password"))

# See what tables are available 
dbListTables(db.con)


# Count rows before upload
country_metrics <- data.table(RPostgres::dbGetQuery(db.con, "SELECT * FROM country_metrics"))

```

